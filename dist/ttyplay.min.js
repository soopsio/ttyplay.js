/**
 * ttyplay.js - ttyrec player for the browser
 * Copyright (c) 2015 Latchezar Tzvetkoff (MIT License)
 * https://github.com/ttyplay/ttyplay.js

 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * @license
 */
!function(t,s){function i(t){for(var s=1,i=arguments.length;i>s;++s){var e=arguments[s];for(var o in e){e.hasOwnProperty(o)&&(t[o]=e[o])}}return t}function e(t,s){return 16777216*t[s+3]+65536*t[s+2]+256*t[s+1]+t[s]}function o(t,s,i){var e=document.createElement(t);if(s){for(var o in s){s.hasOwnProperty(o)&&(e[o]=s[o])}}if(i){if("string"==typeof i){e.appendChild(document.createTextNode(i))}else{if(i.tagName){e.appendChild(i)}else{if(i.length){for(var n=0,r=i.length;r>n;++n){var a=i[n];"string"==typeof a&&(a=document.createTextNode(a)),e.appendChild(a)}}}}}return e}function n(t,s){if("string"==typeof t&&(t=document.getElementById(t)),this.container=t,s=i({},n.defaultOptions,s||{}),this.options=s,this.position=this.options.position,this.initializeTerminal(),s.controls&&this.initializeControls(),s.url){this.loadUrl(s.url)}else{if(s.rawTtyRecord){this.loadRawTtyRecord(s.rawTtyRecord,s.gzip),s.auto&&this.start()}else{if(!s.ttyFrames){throw"No data to replay!"}this.ttyFrames=s.ttyFrames,s.auto&&this.start()}}}n.defaultOptions={url:null,rawTtyRecord:null,gzip:!1,ttyFrames:null,precompose:!1,cols:80,rows:25,speed:1,auto:!1,repeat:!1,position:0,controls:!0},n.ungzip=function(t){return pako.ungzip(t)},n.prototype.destroy=function(){this.terminal&&this.terminal.element&&(this.terminal.element.parentNode.removeChild(this.terminal.element),this.terminal.element=null,this.terminal=null),this.controls&&this.controls.container&&(this.controls.container.parentNode.removeChild(this.controls.container),this.controls=null)},n.prototype.initializeTerminal=function(){this.terminal=new Terminal({cols:this.options.cols,rows:this.options.rows,parent:this.container,cursorBlink:!1}),this.terminal.blur=this.terminal.keyDown=this.terminal.keyPress=function(){},this.terminal.open()},n.prototype.initializeControls=function(){var t=this,s=function(){t.running?t.paused?(t.resume(),t.controls.play.className="pause",t.controls.play.innerHTML="Pause"):(t.pause(),t.controls.play.className="play",t.controls.play.innerHTML="Play"):(t.start(),t.controls.play.className="pause",t.controls.play.innerHTML="Pause")},i=function(){t.stop(),t.controls.play.className="play",t.controls.play.innerHTML="Play"},e=function(s){clearTimeout(t.lastTimeout);var i=Math.round(t.ttyFrames.length*s.offsetX/t.controls.progressWrapper.offsetWidth);t.jump(i),t.running&&!t.paused&&t.resume()},n={};this.controls=n,n.progressBar=o("span"),n.progressWrapper=o("span",{className:"progress",onclick:e},[n.progressBar]),n.play=o("a",{href:"javascript:;",className:"play",onclick:s},"Play"),n.stop=o("a",{href:"javascript:;",className:"stop",onclick:i},"Stop"),n.container=o("span",{className:"controls"},[n.progressWrapper,n.play,n.stop]),this.container.appendChild(n.container)},n.prototype.updateProgressBar=function(){if(this.options.controls){var t=Math.round(100*this.position/this.ttyFrames.length);this.controls.progressBar.style.width=t+"%"}},n.prototype.loadUrl=function(t){var s=this,i=new XMLHttpRequest;i.open("GET",t,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.responseType="arraybuffer",i.onload=function(){s.loadRawTtyRecord(new Uint8Array(this.response),s.options.gzip),s.options.auto&&s.start()},i.send(null)},n.prototype.loadRawTtyRecord=function(t,s){s&&(t=n.ungzip(t));for(var i=[],o=0,r=t.byteLength,a=e(t,0),l=e(t,4);r>o;){var p=e(t,o),h=e(t,o+4),c=p-a+1e-6*(h-l);a=p,l=h;var u=e(t,o+8),m=t.subarray(o+12,o+12+u),y=String.fromCharCode.apply(null,m),f=decodeURIComponent(escape(y)),d=null;this.options.precompose&&(d=i.length?i[i.length-1].fullData+f:f),i.push({index:i.length,time:c,size:u,frameData:f,fullData:d}),o+=12+u}this.ttyFrames=i},n.prototype.start=function(){this.running=!0,this.paused=!1;var t=this.ttyFrames[this.position];t&&this.redraw(t);var s=this.ttyFrames[this.position+1];if(s){var i=this;this.lastTimeout=setTimeout(function(){++i.position,i.tick()},1e3*s.time*this.options.speed)}this.controls&&this.controls.play&&(this.controls.play.className="pause",this.controls.play.innerHTML="Pause")},n.prototype.stop=function(){this.running=!1,this.paused=!1,this.position=0,this.terminal.reset(),this.terminal.showCursor(),this.updateProgressBar(),this.controls&&this.controls.play&&(this.controls.play.className="play",this.controls.play.innerHTML="Play")},n.prototype.pause=function(){this.running&&(clearTimeout(this.lastTimeout),this.paused=!0,this.controls&&this.controls.play&&(this.controls.play.className="play",this.controls.play.innerHTML="Play"))},n.prototype.resume=function(){if(this.running){clearTimeout(this.lastTimeout),this.paused=!1;var t=this.ttyFrames[this.position+1];if(t){var s=this;this.lastTimeout=setTimeout(function(){++s.position,s.tick()},1e3*t.time*this.options.speed)}this.controls&&this.controls.play&&(this.controls.play.className="pause",this.controls.play.innerHTML="Pause")}},n.prototype.redraw=function(t){if(t||(t=this.ttyFrames[this.position]),this.terminal&&this.terminal.element&&this.terminal.element.parentNode.removeChild(this.terminal.element),this.initializeTerminal(),this.terminal.showCursor(),t.fullData){this.terminal.write(t.fullData)}else{for(var s=0;s<=t.index;++s){var i=this.ttyFrames[s];this.terminal.write(i.frameData)}}},n.prototype.jump=function(t){this.position=t,this.updateProgressBar(),this.redraw()},n.prototype.tick=function(){if(this.running&&!this.paused){var t=this.ttyFrames[this.position];if(t&&(this.updateProgressBar(),this.terminal.write(t.frameData),!this.paused)){var s=this.ttyFrames[this.position+1];if(s){var i=this;this.lastTimeout=setTimeout(function(){++i.position,i.tick()},1e3*s.time*this.options.speed)}else{this.options.repeat?(this.stop(),this.start()):(this.position=this.ttyFrames.length,this.updateProgressBar(),this.position=0,this.running=!1,this.controls&&this.controls.play&&(this.controls.play.className="play",this.controls.play.innerHTML="Play"))}}}},t.TTYPlay=n}(this);